<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Chat del Cliente</title>
    <style>
        #chat {
            width: 80%;
            margin: auto;
            max-width: 600px;
        }
        #chat-box {
            border: 1px solid #ccc;
            height: 300px;
            overflow-y: scroll;
            padding: 10px;
            margin-bottom: 10px;
        }
        .own-message { text-align: right; color: blue; }
        .other-message { text-align: left; color: green; }
    </style>
</head>
<body>
    <div id="chat">
        <h2>Chat</h2>
        <div id="chat-box"></div>
        <input type="text" id="message" placeholder="Escribe tu mensaje..." autocomplete="off">
        <button id="send">Enviar</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let userName = null;

        // Prompt para ingresar nombre
        socket.on("connect", () => {
            userName = prompt("Ingresa tu nombre:");
            if (userName) {
                socket.emit("register_name", { name: userName });
                console.log("Nombre enviado al servidor:", userName);
            }
            socket.emit("join");  // Solicita historial
        });

        // Mostrar mensajes recibidos
        socket.on("message", function (msg) {
            displayMessage(msg);
        });

        // Mostrar historial al entrar
        socket.on("chat_history", function (messages) {
            document.getElementById("chat-box").innerHTML = "";
            messages.forEach(displayMessage);
        });

        function displayMessage(data) {
            const div = document.createElement("div");
            const isOwn = data.sender === userName;
            if (data.audio_url) {
                div.innerHTML = `
                    <strong>${data.sender}:</strong> 
                    <button onclick="new Audio('${data.audio_url}').play()">ðŸ”Š Escuchar Audio</button>
                `;
            } else {
                div.textContent = `${data.sender}: ${data.text}`;
            }
            div.classList.add(isOwn ? "own-message" : "other-message");
            document.getElementById("chat-box").appendChild(div);
            document.getElementById("chat-box").scrollTop = document.getElementById("chat-box").scrollHeight;
        }

        // Enviar mensaje
        document.getElementById("send").addEventListener("click", sendMessage);
        document.getElementById("message").addEventListener("keypress", function (e) {
            if (e.key === "Enter") sendMessage();
        });

        function sendMessage() {
            const input = document.getElementById("message");
            const text = input.value.trim();
            if (text !== "") {
                socket.emit("message", { text: text });
                input.value = "";
            }
        }
    </script>
</body>
</html>
